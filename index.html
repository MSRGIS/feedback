<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול משוב לקוחות</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .expanded .collapsible-content {
            max-height: 1000px; /* Adjust as needed */
        }
        .chevron {
            transition: transform 0.3s ease;
        }
        .expanded .chevron {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Spinner -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-white"></div>
    </div>

    <!-- Login Section -->
    <div id="login-section" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8 space-y-6">
            <div class="flex justify-center items-center gap-3 text-gray-800">
                <!-- User's SVG will be loaded here. Make sure 'logo.svg' is in the root folder. -->
                <img src="./logo.svg" alt="לוגו" class="h-10 w-10">
                <h1 class="text-3xl font-bold text-center">מערכת משוב לקוחות</h1>
            </div>
            <p class="text-center text-gray-500">נא התחבר כדי להמשיך</p>
            <div id="auth-error" class="text-red-500 text-center font-semibold hidden"></div>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" placeholder="כתובת מייל" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors" required>
                <input type="password" id="password" placeholder="סיסמה" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors" required>
                <div class="flex items-center">
                    <input id="remember-me" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="remember-me" class="ml-2 rtl:mr-2 block text-sm text-gray-900">זכור אותי</label>
                </div>
                <button type="submit" class="w-full px-4 py-2 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500">התחברות</button>
            </form>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="app-section" class="min-h-screen hidden">
        <header class="bg-white shadow-md sticky top-0 z-30">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div class="flex items-center gap-2">
                     <!-- User's SVG will be loaded here. Make sure 'logo.svg' is in the root folder. -->
                    <img src="./logo.svg" alt="לוגו" class="h-8 w-8">
                    <h1 class="text-2xl font-bold text-indigo-600">ניהול משובים</h1>
                </div>
                <button id="open-menu-btn" title="תפריט" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="mb-6">
                 <button id="open-feedback-modal-btn" class="w-full sm:w-auto px-6 py-3 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    <span>הוספת משוב חדש</span>
                </button>
            </div>

            <!-- Filters Section -->
            <div id="filters-container" class="bg-white rounded-xl shadow-lg mb-6 expanded">
                <button id="toggle-filters-btn" class="w-full p-4 flex justify-between items-center cursor-pointer">
                    <h3 class="text-lg font-bold text-gray-800">סינון וחיפוש</h3>
                    <svg class="h-6 w-6 text-gray-600 chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div class="collapsible-content">
                    <div class="p-4 border-t space-y-4">
                        <div>
                            <label for="filter-text" class="block text-sm font-medium text-gray-700">חיפוש חופשי</label>
                            <input type="text" id="filter-text" placeholder="הקלד לחיפוש..." class="w-full px-3 py-2 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="filter-type" class="block text-sm font-medium text-gray-700">סינון לפי סוג</label>
                                <select id="filter-type" class="w-full px-3 py-2 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                    <option value="">הכל</option>
                                    <option value="תלונה">תלונה</option>
                                    <option value="הצעה לשיפור">הצעה לשיפור</option>
                                    <option value="שאלה טכנית">שאלה טכנית</option>
                                    <option value="מחמאה">מחמאה</option>
                                    <option value="אחר">אחר</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-user" class="block text-sm font-medium text-gray-700">סינון לפי משתמש</label>
                                <select id="filter-user" class="w-full px-3 py-2 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                    <option value="">כל המשתמשים</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-date-start" class="block text-sm font-medium text-gray-700">מתאריך</label>
                                <input type="date" id="filter-date-start" class="w-full px-3 py-2 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="filter-date-end" class="block text-sm font-medium text-gray-700">עד תאריך</label>
                                <input type="date" id="filter-date-end" class="w-full px-3 py-2 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            </div>
                        </div>
                        <div class="flex items-center justify-between pt-2">
                            <div class="flex items-center">
                                <input id="filter-my-feedback" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <label for="filter-my-feedback" class="ml-2 rtl:mr-2 block text-sm text-gray-900">הצג רק את המשובים שלי</label>
                            </div>
                            <button id="reset-filters-btn" class="px-4 py-2 text-sm font-medium text-indigo-700 bg-indigo-100 rounded-lg hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">איפוס סינונים</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="feedback-list" class="space-y-4">
                <!-- Feedback items will be injected here -->
            </div>
        </main>
    </div>

    <!-- Side Menu -->
    <div id="menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden opacity-0 transition-opacity duration-300 ease-in-out"></div>
    <div id="side-menu" class="fixed top-0 right-0 h-full w-80 bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
            <h2 class="font-bold text-lg text-gray-800">תפריט</h2>
            <button id="close-menu-btn" class="p-1 text-gray-500 hover:text-gray-800">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="flex-grow overflow-y-auto">
             <div class="p-4 border-b">
                <h3 class="text-sm text-gray-500 mb-2">סטטוס משתמשים</h3>
                <div id="user-status-list" class="space-y-2">
                    <!-- User status list will be injected here -->
                </div>
            </div>
            <div class="p-4 border-b">
                <h3 class="text-sm text-gray-500 mb-2">סיכום משובים</h3>
                <div id="feedback-stats" class="space-y-2">
                    <!-- Feedback stats will be injected here -->
                </div>
            </div>
        </div>
        <div class="p-4 border-t flex-shrink-0">
            <div>
                <span class="text-sm text-gray-500">מחובר כמשתמש:</span>
                <p id="user-email-menu" class="text-gray-800 font-semibold break-words"></p>
            </div>
            <button id="logout-btn" title="התנתק" class="mt-4 w-full flex items-center justify-center gap-2 p-2 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-transform transform hover:scale-105 bg-red-500 hover:bg-red-600 focus:ring-red-400">
                <span>התנתק</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5h10a1 1 0 100-2H3zm12.293 4.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L16.586 13H7a1 1 0 110-2h9.586l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Add/Edit Feedback Modal -->
    <div id="feedback-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4 invisible opacity-0">
        <div class="w-full max-w-2xl bg-white rounded-xl shadow-lg transform transition-transform scale-95">
             <div class="flex justify-between items-center p-4 border-b">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800">הוספת משוב חדש</h2>
                <button id="close-feedback-modal-btn" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <form id="feedback-form" class="space-y-4">
                    <input type="hidden" id="feedback-id">
                    <div>
                        <label for="feedback-type" class="block text-sm font-medium text-gray-700">סוג הפנייה</label>
                        <select id="feedback-type" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            <option value="" disabled selected>בחר סוג...</option>
                            <option value="תלונה">תלונה</option>
                            <option value="הצעה לשיפור">הצעה לשיפור</option>
                            <option value="שאלה טכנית">שאלה טכנית</option>
                            <option value="מחמאה">מחמאה</option>
                            <option value="אחר">אחר</option>
                        </select>
                    </div>
                    <div>
                        <label for="client-name" class="block text-sm font-medium text-gray-700">שם הלקוח/ה</label>
                        <input type="text" id="client-name" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="client-phone" class="block text-sm font-medium text-gray-700">טלפון</label>
                        <input type="tel" id="client-phone" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                     <div>
                        <label for="client-city" class="block text-sm font-medium text-gray-700">עיר</label>
                        <input type="text" id="client-city" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="client-email" class="block text-sm font-medium text-gray-700">מייל</label>
                        <input type="email" id="client-email" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="feedback-details" class="block text-sm font-medium text-gray-700">פרטי הפנייה/המשוב</label>
                        <textarea id="feedback-details" rows="5" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea>
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button type="submit" id="feedback-submit-btn" class="px-6 py-2 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500">שמירת משוב</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 invisible opacity-0">
        <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-6 space-y-4">
             <h3 class="text-lg font-bold text-gray-800">אישור מחיקה</h3>
             <p class="text-gray-600">האם אתה בטוח שברצונך למחוק את המשוב הזה? לא ניתן לשחזר את הפעולה.</p>
             <div class="flex justify-end space-x-4 rtl:space-x-reverse">
                <button id="cancel-delete-btn" class="px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">ביטול</button>
                <button id="confirm-delete-btn" class="px-4 py-2 text-white bg-red-600 hover:bg-red-700 rounded-lg font-semibold">מחיקה</button>
             </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect, serverTimestamp as serverTimestampRTDB } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginSection = document.getElementById('login-section');
        const appSection = document.getElementById('app-section');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authError = document.getElementById('auth-error');
        const userEmailMenuSpan = document.getElementById('user-email-menu');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const feedbackList = document.getElementById('feedback-list');
        
        // Menu Elements
        const openMenuBtn = document.getElementById('open-menu-btn');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const sideMenu = document.getElementById('side-menu');
        const menuOverlay = document.getElementById('menu-overlay');
        const logoutBtn = document.getElementById('logout-btn');
        const userStatusList = document.getElementById('user-status-list');
        const feedbackStats = document.getElementById('feedback-stats');


        // Modal Elements
        const feedbackModal = document.getElementById('feedback-modal');
        const modalTitle = document.getElementById('modal-title');
        const feedbackSubmitBtn = document.getElementById('feedback-submit-btn');
        const openFeedbackModalBtn = document.getElementById('open-feedback-modal-btn');
        const closeFeedbackModalBtn = document.getElementById('close-feedback-modal-btn');
        const feedbackForm = document.getElementById('feedback-form');
        const feedbackIdInput = document.getElementById('feedback-id');
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        // Filter Elements
        const filtersContainer = document.getElementById('filters-container');
        const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
        const filterText = document.getElementById('filter-text');
        const filterType = document.getElementById('filter-type');
        const filterUser = document.getElementById('filter-user');
        const filterMyFeedback = document.getElementById('filter-my-feedback');
        const filterDateStart = document.getElementById('filter-date-start');
        const filterDateEnd = document.getElementById('filter-date-end');
        const resetFiltersBtn = document.getElementById('reset-filters-btn');

        let auth, db, rtdb;
        let allFeedbacks = [];
        let allRegisteredUsers = []; // Will hold {uid, email} for ALL users
        let feedbackIdToDelete = null;

        // --- Securely Fetch Firebase Config ---
        async function getFirebaseConfig() {
            try {
                const response = await fetch('/.netlify/functions/firebase-config');
                if (!response.ok) throw new Error('Could not fetch Firebase configuration.');
                return await response.json();
            } catch (error) {
                console.error("Error fetching config:", error);
                document.body.innerHTML = '<h1 class="text-center text-red-500 p-8">שגיאה קריטית: לא ניתן לטעון את הגדרות המערכת.</h1>';
                return null;
            }
        }
        
        // --- Fetch All Users ---
        async function fetchAllUsers() {
             try {
                const response = await fetch('/.netlify/functions/get-all-users');
                if (!response.ok) throw new Error('Could not fetch user list.');
                allRegisteredUsers = await response.json();
                return allRegisteredUsers;
            } catch (error) {
                console.error("Error fetching all users:", error);
                allRegisteredUsers = [];
                return [];
            }
        }
        
        // --- Initialize App ---
        async function main() {
            const firebaseConfig = await getFirebaseConfig();
            if (!firebaseConfig) { 
                loadingOverlay.classList.add('hidden'); 
                return; 
            }

            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            rtdb = getDatabase(app);

            onAuthStateChanged(auth, user => {
                loadingOverlay.classList.add('hidden');
                if (user) {
                    initializeAppLogic(user);
                } else {
                    appSection.classList.add('hidden');
                    loginSection.classList.remove('hidden');
                    userEmailMenuSpan.textContent = '';
                }
            });

            setupEventListeners();
        }

        async function initializeAppLogic(user) {
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            userEmailMenuSpan.textContent = user.email;

            // Fetch static data first
            const users = await fetchAllUsers();

            // Setup UI that depends on the static data
            populateUserFilter(users);

            // Setup realtime listeners
            setupPresence(user);
            setupFeedbackListener();
        }
        
        // --- Presence System (Realtime Database) ---
        function setupPresence(user) {
            // We use the user's unique ID (UID) as it's secure and path-safe
            const userStatusRef = ref(rtdb, `status/${user.uid}`);
            
            const connectedRef = ref(rtdb, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    set(userStatusRef, { isOnline: true, lastOnline: serverTimestampRTDB() });
                    onDisconnect(userStatusRef).set({ isOnline: false, lastOnline: serverTimestampRTDB() });
                }
            });
        }

        function setupEventListeners() {
            loginForm.addEventListener('submit', handleLogin);
            
            // Menu Listeners
            openMenuBtn.addEventListener('click', () => {
                updateSideMenuContent();
                sideMenu.classList.remove('translate-x-full');
                menuOverlay.classList.remove('hidden');
                setTimeout(() => menuOverlay.classList.remove('opacity-0'), 10);
            });
            const closeMenu = () => {
                sideMenu.classList.add('translate-x-full');
                menuOverlay.classList.add('opacity-0');
                setTimeout(() => menuOverlay.classList.add('hidden'), 300);
            };
            closeMenuBtn.addEventListener('click', closeMenu);
            menuOverlay.addEventListener('click', closeMenu);
            logoutBtn.addEventListener('click', () => {
                closeMenu();
                signOut(auth);
            });
            
            // Modal Listeners
            openFeedbackModalBtn.addEventListener('click', openAddModal);
            closeFeedbackModalBtn.addEventListener('click', () => closeModal(feedbackModal));
            feedbackModal.addEventListener('click', (e) => { if (e.target === feedbackModal) closeModal(feedbackModal); });
            feedbackForm.addEventListener('submit', handleFeedbackSubmit);

            // Delete Modal Listeners
            deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) closeModal(deleteModal); });
            cancelDeleteBtn.addEventListener('click', () => closeModal(deleteModal));
            confirmDeleteBtn.addEventListener('click', handleDeleteConfirmation);

            // Filter Listeners
            toggleFiltersBtn.addEventListener('click', () => filtersContainer.classList.toggle('expanded'));
            [filterText, filterType, filterUser, filterMyFeedback, filterDateStart, filterDateEnd].forEach(el => {
                el.addEventListener('input', applyFiltersAndRender);
            });
            filterMyFeedback.addEventListener('change', handleMyFeedbackToggle);
            resetFiltersBtn.addEventListener('click', resetFilters);
            feedbackList.addEventListener('click', handleFeedbackListClick);
        }

        // --- Authentication ---
        async function handleLogin(e) {
            e.preventDefault();
            loadingOverlay.classList.remove('hidden');
            authError.classList.add('hidden');
            const persistence = rememberMeCheckbox.checked ? browserLocalPersistence : browserSessionPersistence;
            try {
                await setPersistence(auth, persistence);
                await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
            } catch (error) {
                console.error("Login failed:", error.message);
                authError.textContent = "שם משתמש או סיסמה שגויים.";
                authError.classList.remove('hidden');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        // --- Firestore Data ---
        async function handleFeedbackSubmit(e) {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) { alert("יש להתחבר למערכת."); return; }
            
            const feedbackId = feedbackIdInput.value;
            const feedbackData = {
                type: feedbackForm.querySelector('#feedback-type').value,
                client: {
                    name: feedbackForm.querySelector('#client-name').value,
                    phone: feedbackForm.querySelector('#client-phone').value,
                    city: feedbackForm.querySelector('#client-city').value,
                    email: feedbackForm.querySelector('#client-email').value,
                },
                details: feedbackForm.querySelector('#feedback-details').value,
            };

            try {
                if (feedbackId) { // Update existing feedback
                    const feedbackRef = doc(db, "feedback", feedbackId);
                    await updateDoc(feedbackRef, feedbackData);
                } else { // Add new feedback
                    feedbackData.author = user.email;
                    feedbackData.authorUid = user.uid; // Add the UID for presence tracking
                    feedbackData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "feedback"), feedbackData);
                }
                feedbackForm.reset();
                closeModal(feedbackModal);
            } catch (error) {
                console.error("Error saving document: ", error);
                alert("אירעה שגיאה בשמירת המשוב.");
            }
        }

        function setupFeedbackListener() {
            const q = query(collection(db, "feedback"));
            onSnapshot(q, (querySnapshot) => {
                const feedbacks = [];
                querySnapshot.forEach((doc) => {
                    feedbacks.push({ id: doc.id, ...doc.data() });
                });
                allFeedbacks = feedbacks.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                
                resetFilters();
            });
        }
        
        async function handleDeleteConfirmation() {
            if (!feedbackIdToDelete) return;
            try {
                await deleteDoc(doc(db, "feedback", feedbackIdToDelete));
            } catch (error) {
                console.error("Error removing document: ", error);
                alert("אירעה שגיאה במחיקת המשוב.");
            } finally {
                closeModal(deleteModal);
                feedbackIdToDelete = null;
            }
        }
        
        // --- UI & Filtering Logic ---
        function handleMyFeedbackToggle() {
            filterUser.disabled = filterMyFeedback.checked;
            filterUser.value = filterMyFeedback.checked ? auth.currentUser.email : '';
            applyFiltersAndRender();
        }

        function handleFeedbackListClick(e) {
            const cardHeader = e.target.closest('.card-header');
            const deleteButton = e.target.closest('.delete-btn');
            const editButton = e.target.closest('.edit-btn');

            if (deleteButton) {
                feedbackIdToDelete = deleteButton.dataset.id;
                openModal(deleteModal);
                return;
            }
             if (editButton) {
                const feedbackId = editButton.dataset.id;
                const feedback = allFeedbacks.find(fb => fb.id === feedbackId);
                if (feedback) {
                    openEditModal(feedback);
                }
                return;
            }
            if (cardHeader) {
                cardHeader.parentElement.classList.toggle('expanded');
            }
        }
        
        function populateUserFilter(users) { // expects array of {uid, email}
            const currentVal = filterUser.value;
            filterUser.innerHTML = '<option value="">כל המשתמשים</option>';
            if(users && users.length > 0) {
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.email;
                    option.textContent = user.email;
                    filterUser.appendChild(option);
                });
            }
            filterUser.value = currentVal;
        }

        function resetFilters() {
            filterText.value = '';
            filterType.value = '';
            filterDateStart.value = '';
            filterDateEnd.value = '';
            filterMyFeedback.checked = true;
            if (auth.currentUser) {
                filterUser.value = auth.currentUser.email;
                filterUser.disabled = true;
            } else {
                filterUser.value = '';
                filterUser.disabled = false;
            }
            applyFiltersAndRender();
        }

        function applyFiltersAndRender() {
            let filteredFeedbacks = [...allFeedbacks];
            const searchTerm = filterText.value.toLowerCase();
            const selectedType = filterType.value;
            const selectedUser = filterUser.value;
            const startDate = filterDateStart.value;
            const endDate = filterDateEnd.value;

            if (filterMyFeedback.checked && auth.currentUser) {
                 filteredFeedbacks = filteredFeedbacks.filter(fb => fb.author === auth.currentUser.email);
            } else if (selectedUser) {
                filteredFeedbacks = filteredFeedbacks.filter(fb => fb.author === selectedUser);
            }

            if (searchTerm) {
                filteredFeedbacks = filteredFeedbacks.filter(fb => 
                    fb.details.toLowerCase().includes(searchTerm) ||
                    fb.client.name.toLowerCase().includes(searchTerm) ||
                    fb.client.phone.includes(searchTerm) ||
                    fb.client.city.toLowerCase().includes(searchTerm) ||
                    fb.client.email.toLowerCase().includes(searchTerm)
                );
            }
            if (selectedType) filteredFeedbacks = filteredFeedbacks.filter(fb => fb.type === selectedType);
            if (startDate) {
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                filteredFeedbacks = filteredFeedbacks.filter(fb => fb.createdAt?.toDate() >= start);
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filteredFeedbacks = filteredFeedbacks.filter(fb => fb.createdAt?.toDate() <= end);
            }
            renderFeedback(filteredFeedbacks);
        }

        function getFeedbackTypeColors(type) {
            switch (type) {
                case 'תלונה':       return 'border-red-500 bg-red-100 text-red-700';
                case 'מחמאה':      return 'border-green-500 bg-green-100 text-green-700';
                case 'הצעה לשיפור': return 'border-blue-500 bg-blue-100 text-blue-700';
                case 'שאלה טכנית': return 'border-yellow-500 bg-yellow-100 text-yellow-700';
                default:           return 'border-gray-500 bg-gray-100 text-gray-700';
            }
        }
        
        function updateSideMenuContent() {
            // Update Stats
            const total = allFeedbacks.length;
            const counts = {
                'תלונה': allFeedbacks.filter(f => f.type === 'תלונה').length,
                'מחמאה': allFeedbacks.filter(f => f.type === 'מחמאה').length,
                'הצעה לשיפור': allFeedbacks.filter(f => f.type === 'הצעה לשיפור').length,
                'שאלה טכנית': allFeedbacks.filter(f => f.type === 'שאלה טכנית').length,
                'אחר': allFeedbacks.filter(f => f.type === 'אחר').length,
            };
            const statsHTML = `
                <div class="flex justify-between items-center text-sm">
                    <span class="font-bold">סה"כ משובים:</span>
                    <span class="px-2 py-0.5 bg-gray-700 text-white rounded-full font-semibold">${total}</span>
                </div>
                <div class="flex justify-start items-center gap-2 text-xs flex-wrap">
                    <span class="px-2 py-0.5 ${getFeedbackTypeColors('תלונה').split(' ')[1]} ${getFeedbackTypeColors('תלונה').split(' ')[2]} rounded-full">תלונות: ${counts['תלונה']}</span>
                    <span class="px-2 py-0.5 ${getFeedbackTypeColors('מחמאה').split(' ')[1]} ${getFeedbackTypeColors('מחמאה').split(' ')[2]} rounded-full">מחמאות: ${counts['מחמאה']}</span>
                </div>
                 <div class="flex justify-start items-center gap-2 text-xs flex-wrap">
                    <span class="px-2 py-0.5 ${getFeedbackTypeColors('הצעה לשיפור').split(' ')[1]} ${getFeedbackTypeColors('הצעה לשיפור').split(' ')[2]} rounded-full">הצעות: ${counts['הצעה לשיפור']}</span>
                    <span class="px-2 py-0.5 ${getFeedbackTypeColors('שאלה טכנית').split(' ')[1]} ${getFeedbackTypeColors('שאלה טכנית').split(' ')[2]} rounded-full">טכני: ${counts['שאלה טכנית']}</span>
                    <span class="px-2 py-0.5 ${getFeedbackTypeColors('אחר').split(' ')[1]} ${getFeedbackTypeColors('אחר').split(' ')[2]} rounded-full">אחר: ${counts['אחר']}</span>
                </div>
            `;
            feedbackStats.innerHTML = statsHTML;

            // Update user status list from the master list
            userStatusList.innerHTML = '';
            if (allRegisteredUsers.length === 0) {
                 userStatusList.innerHTML = '<p class="text-xs text-gray-500">לא ניתן היה לטעון את רשימת המשתמשים.</p>';
                 return;
            }

            allRegisteredUsers.sort((a, b) => a.email.localeCompare(b.email)).forEach(user => {
                const statusRef = ref(rtdb, `status/${user.uid}`);
                const listItem = document.createElement('div');
                listItem.className = 'flex items-center gap-2 text-sm';
                listItem.innerHTML = `
                    <span class="h-2 w-2 rounded-full bg-gray-400 animate-pulse"></span>
                    <span class="text-gray-700 break-all">${user.email}</span>
                `;
                userStatusList.appendChild(listItem);

                onValue(statusRef, (snap) => {
                    const status = snap.val() || { isOnline: false };
                    const statusDot = listItem.querySelector('span');
                    statusDot.classList.remove('animate-pulse', 'bg-gray-400');
                    statusDot.classList.toggle('bg-green-500', status.isOnline);
                    statusDot.classList.toggle('bg-red-500', !status.isOnline);
                });
            });
        }


        function renderFeedback(feedbacks) {
            feedbackList.innerHTML = '';
            
            if (filterMyFeedback.checked && feedbacks.length === 0) {
                return; 
            }

            if (feedbacks.length === 0) {
                feedbackList.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center text-gray-500">לא נמצאו משובים התואמים את הסינון.</div>`;
                return;
            }
            
            feedbacks.forEach(fb => {
                const datePart = fb.createdAt ? fb.createdAt.toDate().toLocaleDateString('he-IL', {day: '2-digit', month: '2-digit', year: 'numeric'}) : '';
                const timePart = fb.createdAt ? fb.createdAt.toDate().toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'}) : '';
                const date = fb.createdAt ? `${datePart} • ${timePart}` : 'לא זמין';
                
                const [borderColor, tagBgColor, tagTextColor] = getFeedbackTypeColors(fb.type).split(' ');
                const detailsFirstThreeWords = fb.details.split(/\s+/).slice(0, 3).join(' ') + (fb.details.split(/\s+/).length > 3 ? '...' : '');

                const card = document.createElement('div');
                card.className = `bg-white rounded-xl shadow-lg`;
                card.innerHTML = `
                    <div class="card-header p-4 flex justify-between items-center cursor-pointer border-l-4 ${borderColor} rounded-r-lg">
                        <div class="flex-1 min-w-0 flex items-center gap-4">
                            <span class="text-sm font-bold ${tagTextColor} ${tagBgColor} px-3 py-1 rounded-full w-28 text-center flex-shrink-0">${fb.type}</span>
                            <p class="text-gray-800 truncate">${detailsFirstThreeWords}</p>
                        </div>
                        <div class="flex items-center space-x-2 rtl:space-x-reverse ml-2 rtl:ml-0 rtl:mr-2 flex-shrink-0">
                            <span class="text-xs text-gray-500">${date}</span>
                            <svg class="h-5 w-5 text-gray-500 chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="p-4 border-t space-y-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold text-gray-700">פרטי הפנייה/המשוב</h4>
                                    <p class="text-gray-800 whitespace-pre-wrap mt-1">${fb.details}</p>
                                </div>
                                ${fb.author === auth.currentUser.email ? 
                                    `<div class="flex items-center space-x-2 rtl:space-x-reverse flex-shrink-0 ml-4">
                                        <button class="edit-btn text-gray-400 hover:text-indigo-600 p-1" data-id="${fb.id}">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                                <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                        <button class="delete-btn text-gray-400 hover:text-red-600 p-1" data-id="${fb.id}">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>` : ''}
                            </div>
                            <div class="border-t pt-4 mt-4">
                                <h4 class="font-semibold text-gray-700 mb-2">פרטי הלקוח/ה</h4>
                                <p class="text-sm text-gray-600"><strong class="font-medium">שם:</strong> ${fb.client.name}</p>
                                <p class="text-sm text-gray-600"><strong class="font-medium">טלפון:</strong> <a href="tel:${fb.client.phone}" class="text-indigo-600 hover:underline">${fb.client.phone}</a></p>
                                <p class="text-sm text-gray-600"><strong class="font-medium">עיר:</strong> ${fb.client.city}</p>
                                <p class="text-sm text-gray-600"><strong class="font-medium">מייל:</strong> ${fb.client.email}</p>
                                <p class="text-sm text-gray-500 mt-2"><strong class="font-medium">נפתח על ידי:</strong> ${fb.author}</p>
                            </div>
                        </div>
                    </div>
                `;
                feedbackList.appendChild(card);
            });
        }
        
        // --- Modal Controls ---
        function openModal(modal) {
            modal.classList.remove('invisible', 'opacity-0');
            modal.querySelector('div').classList.remove('scale-95');
        }

        function closeModal(modal) {
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('invisible');
                feedbackForm.reset();
                feedbackIdInput.value = '';
            }, 300);
        }

        function openAddModal() {
            feedbackForm.reset();
            feedbackIdInput.value = '';
            modalTitle.textContent = 'הוספת משוב חדש';
            feedbackSubmitBtn.textContent = 'שמירת משוב';
            openModal(feedbackModal);
        }

        function openEditModal(feedback) {
            feedbackForm.reset();
            feedbackIdInput.value = feedback.id;
            modalTitle.textContent = 'עריכת משוב';
            feedbackSubmitBtn.textContent = 'עדכון משוב';
            
            // Populate form
            feedbackForm.querySelector('#feedback-type').value = feedback.type;
            feedbackForm.querySelector('#client-name').value = feedback.client.name;
            feedbackForm.querySelector('#client-phone').value = feedback.client.phone;
            feedbackForm.querySelector('#client-city').value = feedback.client.city;
            feedbackForm.querySelector('#client-email').value = feedback.client.email;
            feedbackForm.querySelector('#feedback-details').value = feedback.details;
            
            openModal(feedbackModal);
        }

        // --- Start the application ---
        main();

    </script>
</body>
</html>
