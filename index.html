<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול משוב לקוחות</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
        }
        /* הסתרת ספינר ברירת מחדל בשדה מספר */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] {
            -moz-appearance: textfield;
            appearance: none;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Spinner -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-white"></div>
    </div>

    <!-- Login Section -->
    <div id="login-section" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8 space-y-6">
            <h1 class="text-3xl font-bold text-center text-gray-800">מערכת משוב לקוחות</h1>
            <p class="text-center text-gray-500">נא התחבר כדי להמשיך</p>
            <div id="auth-error" class="text-red-500 text-center font-semibold hidden"></div>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" placeholder="כתובת מייל" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors" required>
                <input type="password" id="password" placeholder="סיסמה" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors" required>
                <div class="flex items-center">
                    <input id="remember-me" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="remember-me" class="ml-2 rtl:mr-2 block text-sm text-gray-900">זכור אותי</label>
                </div>
                <button type="submit" class="w-full px-4 py-2 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500">התחברות</button>
            </form>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="app-section" class="min-h-screen hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-600">ניהול משובים</h1>
                <div class="flex items-center space-x-4 rtl:space-x-reverse">
                    <span id="user-email" class="text-gray-600 hidden sm:block"></span>
                    <button id="logout-btn" class="w-auto px-4 py-2 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-transform transform hover:scale-105 bg-red-500 hover:bg-red-600 focus:ring-red-400">התנתק</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Feedback Form -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg self-start">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">הוספת משוב חדש</h2>
                    <form id="feedback-form" class="space-y-4">
                        <div>
                            <label for="feedback-type" class="block text-sm font-medium text-gray-700">סוג הפנייה</label>
                            <select id="feedback-type" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors" required>
                                <option value="" disabled selected>בחר סוג...</option>
                                <option value="תלונה">תלונה</option>
                                <option value="הצעה לשיפור">הצעה לשיפור</option>
                                <option value="שאלה טכנית">שאלה טכנית</option>
                                <option value="מחמאה">מחמאה</option>
                                <option value="אחר">אחר</option>
                            </select>
                        </div>
                        <div>
                            <label for="client-name" class="block text-sm font-medium text-gray-700">שם הלקוח/ה</label>
                            <input type="text" id="client-name" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors" required>
                        </div>
                        <div>
                            <label for="client-phone" class="block text-sm font-medium text-gray-700">טלפון</label>
                            <input type="tel" id="client-phone" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors" required>
                        </div>
                         <div>
                            <label for="client-city" class="block text-sm font-medium text-gray-700">עיר</label>
                            <input type="text" id="client-city" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors" required>
                        </div>
                        <div>
                            <label for="client-email" class="block text-sm font-medium text-gray-700">מייל</label>
                            <input type="email" id="client-email" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors" required>
                        </div>
                        <div>
                            <label for="feedback-details" class="block text-sm font-medium text-gray-700">פרטי הפנייה/המשוב</label>
                            <textarea id="feedback-details" rows="5" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors" required></textarea>
                        </div>
                        <button type="submit" class="w-full px-4 py-2 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500">שליחת משוב</button>
                    </form>
                </div>

                <!-- Feedback List & Filters -->
                <div class="lg:col-span-2">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">רשימת משובים</h2>
                    <!-- Filters Section -->
                    <div class="bg-white p-4 rounded-xl shadow-lg mb-6 space-y-4">
                        <div>
                            <label for="filter-text" class="block text-sm font-medium text-gray-700">חיפוש חופשי</label>
                            <input type="text" id="filter-text" placeholder="הקלד לחיפוש..." class="w-full px-3 py-2 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="filter-type" class="block text-sm font-medium text-gray-700">סינון לפי סוג</label>
                                <select id="filter-type" class="w-full px-3 py-2 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                    <option value="">הכל</option>
                                    <option value="תלונה">תלונה</option>
                                    <option value="הצעה לשיפור">הצעה לשיפור</option>
                                    <option value="שאלה טכנית">שאלה טכנית</option>
                                    <option value="מחמאה">מחמאה</option>
                                    <option value="אחר">אחר</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-user" class="block text-sm font-medium text-gray-700">סינון לפי משתמש</label>
                                <select id="filter-user" class="w-full px-3 py-2 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                    <option value="">כל המשתמשים</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-date-start" class="block text-sm font-medium text-gray-700">מתאריך</label>
                                <input type="date" id="filter-date-start" class="w-full px-3 py-2 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="filter-date-end" class="block text-sm font-medium text-gray-700">עד תאריך</label>
                                <input type="date" id="filter-date-end" class="w-full px-3 py-2 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            </div>
                        </div>
                        <div class="flex items-center justify-between pt-2">
                            <div class="flex items-center">
                                <input id="filter-my-feedback" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <label for="filter-my-feedback" class="ml-2 rtl:mr-2 block text-sm text-gray-900">הצג רק את המשובים שלי</label>
                            </div>
                            <button id="reset-filters-btn" class="px-4 py-2 text-sm font-medium text-indigo-700 bg-indigo-100 rounded-lg hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">איפוס סינונים</button>
                        </div>
                    </div>

                    <div id="feedback-list" class="space-y-4">
                        <!-- Feedback items will be injected here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginSection = document.getElementById('login-section');
        const appSection = document.getElementById('app-section');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authError = document.getElementById('auth-error');
        const userEmailSpan = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const feedbackForm = document.getElementById('feedback-form');
        const feedbackList = document.getElementById('feedback-list');
        const rememberMeCheckbox = document.getElementById('remember-me');

        // Filter Elements
        const filterText = document.getElementById('filter-text');
        const filterType = document.getElementById('filter-type');
        const filterUser = document.getElementById('filter-user');
        const filterMyFeedback = document.getElementById('filter-my-feedback');
        const filterDateStart = document.getElementById('filter-date-start');
        const filterDateEnd = document.getElementById('filter-date-end');
        const resetFiltersBtn = document.getElementById('reset-filters-btn');

        let auth, db;
        let allFeedbacks = []; // To store all feedbacks for client-side filtering

        // --- Step 1: Securely Fetch Firebase Config ---
        async function getFirebaseConfig() {
            try {
                const response = await fetch('/.netlify/functions/firebase-config');
                if (!response.ok) throw new Error('Could not fetch Firebase configuration.');
                return await response.json();
            } catch (error) {
                console.error("Error fetching config:", error);
                document.body.innerHTML = '<h1 class="text-center text-red-500 p-8">שגיאה קריטית: לא ניתן לטעון את הגדרות המערכת.</h1>';
                return null;
            }
        }
        
        // --- Step 2: Initialize Firebase and App Logic ---
        async function main() {
            const firebaseConfig = await getFirebaseConfig();

            if (!firebaseConfig) {
                loadingOverlay.classList.add('hidden');
                return;
            }

            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, user => {
                loadingOverlay.classList.add('hidden');
                if (user) {
                    loginSection.classList.add('hidden');
                    appSection.classList.remove('hidden');
                    userEmailSpan.textContent = user.email;
                    fetchFeedback();
                } else {
                    appSection.classList.add('hidden');
                    loginSection.classList.remove('hidden');
                    userEmailSpan.textContent = '';
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loadingOverlay.classList.remove('hidden');
                authError.classList.add('hidden');
                
                const persistence = rememberMeCheckbox.checked ? browserLocalPersistence : browserSessionPersistence;
                
                try {
                    await setPersistence(auth, persistence);
                    await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                } catch (error) {
                    console.error("Login failed:", error.message);
                    authError.textContent = "שם משתמש או סיסמה שגויים.";
                    authError.classList.remove('hidden');
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            });

            logoutBtn.addEventListener('click', () => signOut(auth));

            feedbackForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) { alert("יש להתחבר למערכת."); return; }

                const feedbackData = {
                    author: user.email,
                    type: document.getElementById('feedback-type').value,
                    client: {
                        name: document.getElementById('client-name').value,
                        phone: document.getElementById('client-phone').value,
                        city: document.getElementById('client-city').value,
                        email: document.getElementById('client-email').value,
                    },
                    details: document.getElementById('feedback-details').value,
                    createdAt: serverTimestamp()
                };
                
                try {
                    await addDoc(collection(db, "feedback"), feedbackData);
                    feedbackForm.reset();
                } catch (error) {
                    console.error("Error adding document: ", error);
                    alert("אירעה שגיאה בשמירת המשוב.");
                }
            });

            // Add event listeners to filters
            [filterText, filterType, filterUser, filterMyFeedback, filterDateStart, filterDateEnd].forEach(el => {
                el.addEventListener('input', applyFiltersAndRender);
            });
            
            // Toggle user filter when checkbox is changed
            filterMyFeedback.addEventListener('change', () => {
                if (filterMyFeedback.checked) {
                    filterUser.value = auth.currentUser.email;
                    filterUser.disabled = true;
                } else {
                    filterUser.value = '';
                    filterUser.disabled = false;
                }
                applyFiltersAndRender();
            });

            resetFiltersBtn.addEventListener('click', resetFilters);
        }

        function fetchFeedback() {
            const q = query(collection(db, "feedback"));
            onSnapshot(q, (querySnapshot) => {
                const feedbacks = [];
                const users = new Set();
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    feedbacks.push({ id: doc.id, ...data });
                    if(data.author) users.add(data.author);
                });
                
                allFeedbacks = feedbacks.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                
                populateUserFilter(users);
                resetFilters(); // Call reset to set the initial default view
            });
        }

        function populateUserFilter(users) {
            const currentVal = filterUser.value;
            filterUser.innerHTML = '<option value="">כל המשתמשים</option>'; // Reset
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                filterUser.appendChild(option);
            });
            filterUser.value = currentVal;
        }

        function resetFilters() {
            filterText.value = '';
            filterType.value = '';
            filterDateStart.value = '';
            filterDateEnd.value = '';
            
            filterMyFeedback.checked = true;
            
            if (auth.currentUser) {
                filterUser.value = auth.currentUser.email;
                filterUser.disabled = true;
            } else {
                filterUser.value = '';
                filterUser.disabled = false;
            }

            applyFiltersAndRender();
        }

        function applyFiltersAndRender() {
            let filteredFeedbacks = [...allFeedbacks];
            const searchTerm = filterText.value.toLowerCase();
            const selectedType = filterType.value;
            const selectedUser = filterUser.value;
            const startDate = filterDateStart.value;
            const endDate = filterDateEnd.value;


            if (searchTerm) {
                filteredFeedbacks = filteredFeedbacks.filter(fb => 
                    fb.details.toLowerCase().includes(searchTerm) ||
                    fb.client.name.toLowerCase().includes(searchTerm) ||
                    fb.client.phone.includes(searchTerm) ||
                    fb.client.city.toLowerCase().includes(searchTerm) ||
                    fb.client.email.toLowerCase().includes(searchTerm)
                );
            }

            if (selectedType) {
                filteredFeedbacks = filteredFeedbacks.filter(fb => fb.type === selectedType);
            }

            if (selectedUser) {
                filteredFeedbacks = filteredFeedbacks.filter(fb => fb.author === selectedUser);
            }

            if (startDate) {
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0); // Set to start of the day
                filteredFeedbacks = filteredFeedbacks.filter(fb => {
                    const fbDate = fb.createdAt?.toDate();
                    return fbDate && fbDate >= start;
                });
            }

            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999); // Set to end of the day
                filteredFeedbacks = filteredFeedbacks.filter(fb => {
                    const fbDate = fb.createdAt?.toDate();
                    return fbDate && fbDate <= end;
                });
            }
            
            renderFeedback(filteredFeedbacks);
        }

        function getFeedbackTypeColors(type) {
            switch (type) {
                case 'תלונה':       return 'border-red-500 bg-red-100 text-red-700';
                case 'מחמאה':      return 'border-green-500 bg-green-100 text-green-700';
                case 'הצעה לשיפור': return 'border-blue-500 bg-blue-100 text-blue-700';
                case 'שאלה טכנית': return 'border-yellow-500 bg-yellow-100 text-yellow-700';
                default:           return 'border-gray-500 bg-gray-100 text-gray-700';
            }
        }

        function renderFeedback(feedbacks) {
            feedbackList.innerHTML = '';
            if (feedbacks.length === 0) {
                feedbackList.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center text-gray-500">לא נמצאו משובים התואמים את הסינון.</div>`;
                return;
            }
            
            feedbacks.forEach(fb => {
                const date = fb.createdAt ? fb.createdAt.toDate().toLocaleString('he-IL', { dateStyle: 'short', timeStyle: 'short' }) : 'לא זמין';
                const [borderColor, tagBgColor, tagTextColor] = getFeedbackTypeColors(fb.type).split(' ');
                
                const card = document.createElement('div');
                card.className = `bg-white p-6 rounded-xl shadow-lg border-l-4 ${borderColor}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-sm font-bold ${tagTextColor} ${tagBgColor} px-3 py-1 rounded-full">${fb.type}</span>
                        <span class="text-xs text-gray-500">${date}</span>
                    </div>
                    <p class="text-gray-800 mb-4 whitespace-pre-wrap">${fb.details}</p>
                    <div class="border-t pt-4 mt-4">
                        <h4 class="font-semibold text-gray-700 mb-2">פרטי הלקוח/ה</h4>
                        <p class="text-sm text-gray-600"><strong class="font-medium">שם:</strong> ${fb.client.name}</p>
                        <p class="text-sm text-gray-600"><strong class="font-medium">טלפון:</strong> <a href="tel:${fb.client.phone}" class="text-indigo-600 hover:underline">${fb.client.phone}</a></p>
                        <p class="text-sm text-gray-600"><strong class="font-medium">עיר:</strong> ${fb.client.city}</p>
                        <p class="text-sm text-gray-600"><strong class="font-medium">מייל:</strong> ${fb.client.email}</p>
                        <p class="text-sm text-gray-500 mt-2"><strong class="font-medium">נפתח על ידי:</strong> ${fb.author}</p>
                    </div>
                `;
                feedbackList.appendChild(card);
            });
        }

        // Start the application
        main();
    </script>
</body>
</html>